name: Build and Deploy Branch Preview

on:
  push:
    branches:
      - 'claude/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-preview:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Cache dependencies for faster builds
      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended texlive-xetex pandoc
          version: 1.0

      # Install all dependencies in a single step
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-xetex \
            pandoc

      # Display versions for debugging
      - name: Display versions
        run: |
          echo "Pandoc version:"
          pandoc --version | head -n 1
          echo "XeLaTeX version:"
          xelatex --version | head -n 1

      # Build DOCX
      - name: Convert LaTeX to DOCX
        run: |
          echo "Building DOCX..."
          pandoc cv.tex -s -o cv.docx
          if [ ! -f cv.docx ]; then
            echo "Error: cv.docx was not created"
            exit 1
          fi
          echo "‚úì DOCX created successfully"

      # Build PDF using Pandoc
      - name: Convert LaTeX to PDF
        run: |
          echo "Building PDF..."
          pandoc cv.tex -s -o cv.pdf --pdf-engine=xelatex --variable geometry:margin=1in
          if [ ! -f cv.pdf ]; then
            echo "Error: cv.pdf was not created"
            exit 1
          fi
          echo "‚úì PDF created successfully"

      # Build HTML with custom template
      - name: Convert LaTeX to HTML
        run: |
          echo "Building HTML..."
          pandoc cv.tex \
            -s \
            -o index.html \
            --to=html5 \
            --template=template.html \
            --section-divs \
            --self-contained \
            --metadata title="Muzamil Ahmed - CV (Preview)" \
            --metadata pagetitle="Muzamil Ahmed - Software Engineer & DevOps Specialist (Preview)"
          if [ ! -f index.html ]; then
            echo "Error: index.html was not created"
            exit 1
          fi
          echo "‚úì HTML created successfully"

      # Clean LaTeX artifacts
      - name: Clean build artifacts
        run: |
          rm -f *.aux *.log *.out *.toc *.fdb_latexmk *.fls *.synctex.gz
          rm -f *.bbl *.blg *.bcf *.run.xml
          echo "‚úì Cleaned LaTeX artifacts"

      # Get branch name for preview directory
      - name: Extract branch name
        id: branch
        run: |
          # Extract branch name and sanitize for URL
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          # Remove 'claude/' prefix and sanitize
          CLEAN_BRANCH=$(echo "${BRANCH_NAME#claude/}" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
          echo "branch_name=${CLEAN_BRANCH}" >> $GITHUB_OUTPUT
          echo "full_branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "Preview will be deployed to: preview/${CLEAN_BRANCH}"

      # Prepare preview directory
      - name: Prepare preview directory
        run: |
          mkdir -p preview/${{ steps.branch.outputs.branch_name }}

          # Copy main outputs
          cp index.html cv.pdf cv.docx preview/${{ steps.branch.outputs.branch_name }}/

          # Copy assets
          [ -f styles.css ] && cp styles.css preview/${{ steps.branch.outputs.branch_name }}/ || echo "No styles.css found"
          [ -f script.js ] && cp script.js preview/${{ steps.branch.outputs.branch_name }}/ || echo "No script.js found"
          [ -f favicon-32x32.png ] && cp favicon*.png preview/${{ steps.branch.outputs.branch_name }}/ 2>/dev/null || true
          [ -f apple-touch-icon.png ] && cp apple-touch-icon.png preview/${{ steps.branch.outputs.branch_name }}/ 2>/dev/null || true
          [ -f og-image.png ] && cp og-image.png preview/${{ steps.branch.outputs.branch_name }}/ 2>/dev/null || true

          # Create a simple index page for the preview directory listing
          cat > preview/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>CV Branch Previews</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      background: #0a0e27;
                      color: #e4e6eb;
                  }
                  h1 { color: #00ffff; }
                  ul { list-style: none; padding: 0; }
                  li { margin: 15px 0; }
                  a {
                      color: #00ffff;
                      text-decoration: none;
                      font-size: 18px;
                      padding: 10px 15px;
                      display: inline-block;
                      border: 1px solid #00ffff;
                      border-radius: 5px;
                      transition: all 0.3s;
                  }
                  a:hover {
                      background: #00ffff;
                      color: #0a0e27;
                  }
                  .back {
                      margin-bottom: 20px;
                  }
                  .back a {
                      font-size: 14px;
                      border-color: #0099ff;
                      color: #0099ff;
                  }
                  .back a:hover {
                      background: #0099ff;
                      color: #0a0e27;
                  }
              </style>
          </head>
          <body>
              <div class="back">
                  <a href="../">‚Üê Back to Main CV</a>
              </div>
              <h1>Branch Previews</h1>
              <p>Available preview branches:</p>
              <ul id="branches"></ul>
              <script>
                  // This will be updated by the workflow
                  const branches = [];
                  const ul = document.getElementById('branches');
                  if (branches.length === 0) {
                      ul.innerHTML = '<li>No preview branches available yet.</li>';
                  } else {
                      branches.forEach(branch => {
                          const li = document.createElement('li');
                          const a = document.createElement('a');
                          a.href = branch + '/';
                          a.textContent = branch;
                          li.appendChild(a);
                          ul.appendChild(li);
                      });
                  }
              </script>
          </body>
          </html>
          EOF

          echo "‚úì Preview directory prepared"
          echo "Contents of preview directory:"
          ls -lh preview/${{ steps.branch.outputs.branch_name }}/

      # Checkout existing gh-pages to preserve main site and other previews
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-content
        continue-on-error: true

      # Prepare deployment directory with existing content
      - name: Prepare deployment
        run: |
          # Create deployment directory structure
          mkdir -p deploy

          # If gh-pages exists, copy existing content to preserve main site
          if [ -d "gh-pages-content" ]; then
            echo "Preserving existing gh-pages content..."
            cp -r gh-pages-content/* deploy/ 2>/dev/null || true
          fi

          # Create preview directory structure
          mkdir -p deploy/preview/${{ steps.branch.outputs.branch_name }}

          # Copy preview build files
          cp preview/${{ steps.branch.outputs.branch_name }}/* deploy/preview/${{ steps.branch.outputs.branch_name }}/

          # Create/update preview index page
          cat > deploy/preview/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>CV Branch Previews</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      background: #0a0e27;
                      color: #e4e6eb;
                  }
                  h1 { color: #00ffff; }
                  ul { list-style: none; padding: 0; }
                  li { margin: 15px 0; }
                  a {
                      color: #00ffff;
                      text-decoration: none;
                      font-size: 18px;
                      padding: 10px 15px;
                      display: inline-block;
                      border: 1px solid #00ffff;
                      border-radius: 5px;
                      transition: all 0.3s;
                  }
                  a:hover {
                      background: #00ffff;
                      color: #0a0e27;
                  }
                  .back {
                      margin-bottom: 20px;
                  }
                  .back a {
                      font-size: 14px;
                      border-color: #0099ff;
                      color: #0099ff;
                  }
                  .back a:hover {
                      background: #0099ff;
                      color: #0a0e27;
                  }
              </style>
          </head>
          <body>
              <div class="back">
                  <a href="../">‚Üê Back to Main CV</a>
              </div>
              <h1>Branch Previews</h1>
              <p>Available preview branches:</p>
              <ul>
          EOF

          # List all preview directories
          for dir in deploy/preview/*/; do
              if [ -d "$dir" ] && [ "$(basename "$dir")" != "index.html" ]; then
                  branch_name=$(basename "$dir")
                  echo "                  <li><a href=\"${branch_name}/\">${branch_name}</a></li>" >> deploy/preview/index.html
              fi
          done

          cat >> deploy/preview/index.html << 'EOF'
              </ul>
          </body>
          </html>
          EOF

          echo "‚úì Deployment prepared"
          ls -lh deploy/preview/${{ steps.branch.outputs.branch_name }}/

      # Deploy to gh-pages using peaceiris action
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          keep_files: true
          commit_message: "Deploy preview for branch: ${{ steps.branch.outputs.full_branch }}"

      # Post preview URL as a summary
      - name: Create deployment summary
        run: |
          echo "## üöÄ Branch Preview Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your branch preview is now available at:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó **Preview URL:** https://muzahm01.github.io/cv/preview/${{ steps.branch.outputs.branch_name }}/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìã **Branch:** \`${{ steps.branch.outputs.full_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ú® Changes will be visible within a few minutes after deployment." >> $GITHUB_STEP_SUMMARY
