name: Build and Deploy CV

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Cache dependencies for faster builds
      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended texlive-xetex pandoc
          version: 1.0

      # Install all dependencies in a single step
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-xetex \
            pandoc

      # Display versions for debugging
      - name: Display versions
        run: |
          echo "Pandoc version:"
          pandoc --version | head -n 1
          echo "XeLaTeX version:"
          xelatex --version | head -n 1

      # Build DOCX
      - name: Convert LaTeX to DOCX
        run: |
          echo "Building DOCX..."
          pandoc cv.tex -s -o cv.docx
          if [ ! -f cv.docx ]; then
            echo "Error: cv.docx was not created"
            exit 1
          fi
          echo "✓ DOCX created successfully"

      # Build PDF using Pandoc (more consistent than pdflatex)
      - name: Convert LaTeX to PDF
        run: |
          echo "Building PDF..."
          pandoc cv.tex -s -o cv.pdf --pdf-engine=xelatex --variable geometry:margin=1in
          if [ ! -f cv.pdf ]; then
            echo "Error: cv.pdf was not created"
            exit 1
          fi
          echo "✓ PDF created successfully"

      # Build HTML with custom template
      - name: Convert LaTeX to HTML
        run: |
          echo "Building HTML..."
          pandoc cv.tex \
            -s \
            -o index.html \
            --to=html5 \
            --template=template.html \
            --section-divs \
            --self-contained \
            --metadata title="Muzamil Ahmed - CV" \
            --metadata pagetitle="Muzamil Ahmed - Software Engineer & DevOps Specialist"
          if [ ! -f index.html ]; then
            echo "Error: index.html was not created"
            exit 1
          fi
          echo "✓ HTML created successfully"

      # Validate build outputs
      - name: Validate build outputs
        run: |
          echo "Checking file sizes..."
          ls -lh index.html cv.pdf cv.docx

          # Check minimum file sizes (basic validation)
          html_size=$(stat -f%z index.html 2>/dev/null || stat -c%s index.html)
          pdf_size=$(stat -f%z cv.pdf 2>/dev/null || stat -c%s cv.pdf)
          docx_size=$(stat -f%z cv.docx 2>/dev/null || stat -c%s cv.docx)

          if [ "$html_size" -lt 1000 ]; then
            echo "Error: HTML file is too small (${html_size} bytes)"
            exit 1
          fi

          if [ "$pdf_size" -lt 1000 ]; then
            echo "Error: PDF file is too small (${pdf_size} bytes)"
            exit 1
          fi

          if [ "$docx_size" -lt 1000 ]; then
            echo "Error: DOCX file is too small (${docx_size} bytes)"
            exit 1
          fi

          echo "✓ All files validated successfully"

      # Setup Node.js for testing tools
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install testing tools
      - name: Install testing tools
        run: |
          npm install -g vnu-jar pa11y-ci
        continue-on-error: true

      # Validate HTML
      - name: Validate HTML
        run: |
          if command -v vnu &> /dev/null; then
            echo "Running HTML validation..."
            vnu --skip-non-html index.html || echo "⚠ HTML validation warnings found"
          else
            echo "⚠ Skipping HTML validation (vnu not available)"
          fi
        continue-on-error: true

      # Run accessibility tests
      - name: Accessibility tests
        run: |
          if command -v pa11y-ci &> /dev/null; then
            echo "Running accessibility tests..."
            pa11y-ci index.html --standard WCAG2AA || echo "⚠ Accessibility issues found"
          else
            echo "⚠ Skipping accessibility tests (pa11y-ci not available)"
          fi
        continue-on-error: true

      # Clean LaTeX artifacts
      - name: Clean build artifacts
        run: |
          rm -f *.aux *.log *.out *.toc *.fdb_latexmk *.fls *.synctex.gz
          rm -f *.bbl *.blg *.bcf *.run.xml
          echo "✓ Cleaned LaTeX artifacts"

      # Prepare public directory with all assets
      - name: Prepare public directory
        run: |
          mkdir -p public

          # Copy main outputs
          cp index.html cv.pdf cv.docx public/

          # Copy assets if they exist (styles, scripts, images, etc.)
          [ -f styles.css ] && cp styles.css public/ || echo "No styles.css found"
          [ -f script.js ] && cp script.js public/ || echo "No script.js found"
          [ -f favicon-32x32.png ] && cp favicon*.png public/ 2>/dev/null || true
          [ -f apple-touch-icon.png ] && cp apple-touch-icon.png public/ 2>/dev/null || true
          [ -f og-image.png ] && cp og-image.png public/ 2>/dev/null || true

          echo "✓ Public directory prepared"
          echo "Contents of public directory:"
          ls -lh public/
  
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          name: pages_contents
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        with:
          artifact_name: pages_contents
