name: Build and Deploy CV

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install TeX Live and Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base pandoc

      - name: Extract Sections from LaTeX
        run: |
          # Extract Introduction
          sed -n '/\\section\*\{Introduction\}/,/\\section\*\{Skills\}/p' cv.tex | sed '1d;$d' > introduction.md
          # Extract Resume (Experience and Education)
          echo -e "### Resume\n" > resume.md
          sed -n '/\\section\*\{Professional Experience\}/,/\\section\*\{Education\}/p' cv.tex | sed '1d;$d' >> resume.md
          sed -n '/\\section\*\{Education\}/,/\\section\*\{Certifications\}/p' cv.tex | sed '1d;$d' >> resume.md
          # Extract Skills & Achievements
          echo -e "### Skills & Achievements\n" > skills-achievements.md
          sed -n '/\\section\*\{Skills\}/,/\\section\*\{Professional Experience\}/p' cv.tex | sed '1d;$d' >> skills-achievements.md
          sed -n '/\\section\*\{Certifications\}/,/\\section\*\{Publications\}/p' cv.tex | sed '1d;$d' >> skills-achievements.md
          sed -n '/\\section\*\{Publications\}/,/\\section\*\{References\}/p' cv.tex | sed '1d;$d' >> skills-achievements.md
          # Extract References
          echo -e "### References\n" > references.md
          sed -n '/\\section\*\{References\}/,/\\end\{document\}/p' cv.tex | sed '1d;$d' >> references.md

      - name: Convert Markdown to HTML Fragments
        run: |
          pandoc -f latex -t html introduction.md -o introduction.html
          pandoc -f latex -t html resume.md -o resume.html
          pandoc -f latex -t html skills-achievements.md -o skills-achievements.html
          pandoc -f latex -t html references.md -o references.html

      - name: Assemble Final HTML
        run: |
          BODY_CONTENT=$(cat introduction.html resume.html skills-achievements.html references.html)
          sed -e "/\\\$body\\\$/r /dev/stdin" -e "/\\\$body\\\$/d" template.html <<< "$BODY_CONTENT" > index.html
      
      - name: Generate PDF and DOCX
        run: |
          pandoc cv.tex -s -o cv.docx
          pdflatex cv.tex

      - name: Prepare public directory
        run: |
          mkdir public
          mv index.html cv.pdf cv.docx public/

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          name: pages_contents
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        with:
          artifact_name: pages_contents
